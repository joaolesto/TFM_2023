<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="css/estiloEN.css">
    <script src="https://code.jquery.com/jquery-3.6.4.min.js" integrity="sha256-oP6HI9z1XaZNBrJURtCoUT5SUnxFr8s3BzRl+cbzUq8=" crossorigin="anonymous"></script>
    <script type="text/javascript" src="js/validator.js"></script>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estradas Nacionais (EN)</title>
</head>
<h1>Estradas Nacionais (EN)</h1>
<body>
    <div class="parent">
        <div class="form-input-gerais">
            <form name="input" id="input_geral" class="form" method="post">
                <fieldset>
                    <legend>Inputs Gerais</legend>
                    <div class="general-inputs">
                        <div class="row">
                            <label for="car_volume_d">Volume de tráfego na direção pretendida (veiculos/h)</label>
                            <input type="number" name="car_volume_d" id="car_volume_d" min="0" number-only />
                        </div>
                        <div class="row">
                            <label for="car_volume_o">Volume de tráfego na direção oposta (veiculos/h)</label>
                            <input type="number" name="car_volume_o" id="car_volume_o" min="0" number-only />
                        </div>
                        <div class="row">
                            <label for="phf">Fator de Ponta Horário</label>
                            <input type="number" name="phf" id="phf" step="0.01" min="0.80" max="0.95" />
                        </div>
                        <div class="row">
                            <label for="pt">% de Veiculos Pesados</label>
                            <input type="number" name="pt" id="pt" min="0" max="100"/>
                        </div>
                        <div class="row">
                            <label for="pr">% de Veiculos Recriativos</label>
                            <input type="number" name="pr" id="pr" min="0" max="100"/>
                        </div>
                        <input type="radio" name="FFS" id="FFS_m"/>
                        <label for="FFS_m">FFS (com dados de campo)</label>
                        <input type="radio" name="FFS" id="FFS_c"/>
                        <label for="FFS_c">FFS (Calculado)</label>
                        <div class="row">
                            <label for="length">Comprimento da Via (km)</label>
                            <input type="number" name="length" id="length" step ="0.01" min="0" max="100" />
                        </div>
                        <div class="row"  style="display: none">
                            <label for="SFM">Velocidade média medida no terreno (km/h)</label>
                            <input type="number" name="FFS_m" id="SFM" min="0"/>
                        </div>
                        <div class="row" style="display: none">
                            <label for="berma">Largura da Berma (m)</label>
                            <input type="number" name="berma" id="berma" step ="0.01" min="0"/>
                        </div>
                        <div class="row" style="display: none">
                            <label for="via">Largura da Via (m)</label>
                            <input type="number" name="via" id="via" step ="0.01" min="3.0"/>
                        </div>
                        <div class="row"  style="display: none">
                            <label for="N_acessos">Número de Acessos</label>
                            <input type="number" name="acessos" id="N_acessos" min="0" />
                        </div>
                    </div>
                </fieldset>
            </form>
        </div>
        <div class="form-hcm-2000">
            <form name="input" id="input_HCM2000" class="form" method="post">
                <fieldset>
                    <legend>Inputs HCM 2000</legend>
                    <input type="radio" name="terreno" id="ondulado" />
                    <label for="ondulado">Terreno Ondulado</label>
                    <br/>
                    <input type="radio" name="terreno" id="plano" />
                    <label for="plano">Terreno Plano</label>
                    <br/>
                    <div class="row">
                        <label for="classe_estrada">Classe de Estrada</label>
                        <select id= "classe_estrada" name="classe_estrada">
                            <option value="">Select Option</option>
                            <option>1</option>
                            <option>2</option>
                        </select>
                    </div>
                    <div class="row">
                        <label for="BFFS">Velocidade base em regime livre (km/h)</label>
                        <input type="number" name="BFFS" id="BFFS" min="45"/>
                    </div>
                </fieldset>
            </form>
        </div>
        <div class="form-outputs_2000">
            <form name="outputs-2000" id="outputs" class="form" action="php/validation.php" method="post">
                <table id="tabela">
                    <thead>
                    <tr>
                        <th>Outputs</th>
                        <th>HCM 2000</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td id="label_vd_s">Débito (velocidade) (sentido em análise) (vc/h)</td>
                        <td><input type="text" name="vd_s" id="vd_s" disabled></td>
                    </tr>
                    <tr>
                        <td id="label_vo_s">Débito (velocidade) (sentido oposto)</td>
                        <td><input type="text" name="vo_s" id="vo_s" disabled></td>
                    </tr>
                    <tr>
                        <td id="label_vd_ts">Débito (tempo de seguimento) (sentido em análise)</td>
                        <td><input type="text" name="vd_ts" id="vd_ts" disabled></td>
                    </tr>
                    <tr>
                        <td id="label_vo_ts">Débito (tempo de seguimento) (sentido oposto)</td>
                        <td><input type="text" name="vo_ts" id="vo_ts" disabled></td>
                    </tr>
                    <tr>
                        <td id="label_ffs">Velocidade de fluxo livre (km/h)</td>
                        <td><input type="text" name="ffs_o" id="FFS_o" disabled></td>
                    </tr>
                    <tr>
                        <td id="label_ATS_d">Velocidade média de viagem (km/h)</td>
                        <td><input type="text" name="ATS_d" id="ATS_d" disabled></td>
                    </tr>
                    <tr>
                        <td id="label_PTSF_d">% de tempo de seguimento</td>
                        <td><input type="text" name="PTSF_d" id="PTSF_d" disabled></td>
                    </tr>
                    </tbody>
                </table>
            </form>
        </div>
        <div class="form-outputs_2022">
            <form name="outputs_2022" id="outputs_2022" class="form" action="php/validation.php" method="post">
                <table id="tabela_2022">
                    <thead>
                    <tr>
                        <th>Outputs</th>
                        <th>HCM 7ª edição</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td id="label_fhv_2022">Velocidade de fluxo base (km/h)</td>
                        <td><input type="text" name="fhv_2022" id="fhv_2022" disabled></td>
                    </tr>
                    <tr>
                        <td id="label_vp_2022">Débito de trafeto (no sentido em análise) (uvl/h)</td>
                        <td><input type="text" name="vp_2022" id="vp_2022" disabled></td>
                    </tr>
                    <tr>
                        <td id="label_ffs_2022">Velocidade de fluxo livre (km/h)</td>
                        <td><input type="text" name="ffs_o_2022" id="FFS_o_2022" disabled></td>
                    </tr>
                    <tr>
                        <td id="label_velocidade_media_2022">Velocidade média (km/h)</td>
                        <td><input type="text" name="velocidade_media_2022" id="S_2022" disabled></td>
                    </tr>
                    <tr>
                        <td id="label_densidade_2022">Densidade de tráfego por via (uvl/km/via)</td>
                        <td><input type="text" name="densidade_2022" id="D_2022" disabled></td>
                    </tr>
                    <tr>
                        <td id="label_densidade_2022">% de seguidores</td>
                        <td><input type="text" name="densidade_2022" id="D_2022" disabled></td>
                    </tr>
                    <tr>
                        <td id="label_densidade_2022">% de seguidores para 25% da capacidade</td>
                        <td><input type="text" name="densidade_2022" id="D_2022" disabled></td>
                    </tr>
                    </tbody>
                </table>
            </form>
        </div>
        <div class="form-hcm-7-edition">
            <form name="input" id="input_HCM7" class="form" method="post">
                <fieldset>
                    <legend>Inputs HCM 7ª Edição</legend>
                    <div class="row">
                        <label for="tipo_segmento">Tipo de Segmento</label>
                        <select id="tipo_segmento" name="Tipo_de_Segmento">
                            <option value="">Select Option</option>
                            <option>Zona de Ultrapassagem</option>
                            <option>Zona de Ultrapassagem Impedida</option>
                        </select>
                    </div>
                    <div class="row">
                        <label for="Spl">Limite de velocidade (km/h)</label>
                        <input type="number" name="ldv" id="ldv" min="45"/>
                    </div>
                    <div class="row">
                        <label for="inclinação">Inclinação longitudinal (%)</label>
                        <input type="number" name="inclinação" id="inclinação" min="0" max="100"/>
                    </div>
                </fieldset>
            </form>
        </div>
        <div class="form-outputs-gerais">
            <form name="outputs_gerais" id="outputs_gerais" class="form" action="php/validation.php" method="post">
                <table id="tabela_gerais">
                    <thead>
                    <tr>
                        <th>Outputs</th>
                        <th>HCM 2000</th>
                        <th>HCM 7ª edição</th>
                    </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td id="label_service_level_gerais">Nivel de Serviço</td>
                            <td><input type="text" name="service_level_gerais" id="service_level_gerais" disabled></td>
                            <td><input type="text" name="ffs_o_gerais" id="FFS_o_gerais" disabled></td>
                        </tr>
                    </tbody>
                </table>
            </form>
            <div class="buttons">
                <button type="submit" id="Calcular">Calcular</button>
                <button type="submit" id="Exportar">Exportar</button>
                <button type="submit" id="Limpar_gerais">Limpar Dados</button>
            </div>
        </div>
    </div>
</body>
<script type="text/javascript">
    $(function () {
        $("#FFS_m").click(function () {
            if ($(this).is(":checked")) {
                $("#SFM").attr("disabled", false).parent().show();
                $("#via").attr("disabled",true).parent().hide();
                $("#berma").attr("disabled",true).parent().hide();
                $("#BFFS").attr("disabled",true).parent().hide();
                $("#N_acessos").attr("disabled",true).parent().hide();
            }
        });
    });
    $(function () {
        $("#FFS_c").click(function () {
            if ($(this).is(":checked")) {
                $("#SFM").attr("disabled", true).parent().hide();
                $("#berma").attr("disabled",false).parent().show();
                $("#via").attr("disabled",false).parent().show();
                $("#BFFS").attr("disabled",false).parent().show();
                $("#N_acessos").attr("disabled",false).parent().show();
            }
        });
    });
</script>
<script src="js/EN_HCM2000.js"></script>
<script src="js/EN_HCM2022.js"></script>
<script>
    $('#Exportar').on('click', function (e) {
        e.preventDefault();

        let data_input = [];
        let data_output = [];

        // preparation to send the post inputs
        data_input.push('Terreno')
        data_input.push($('input[name="terreno"]:checked').next('label').text())

        data_input.push('FFS')
        data_input.push($('input[name="FFS"]:checked').next('label').text())


        $('.general-inputs .row').each(function (key, el) {
            // get the labels and inputs
            let $el = $(el);
            let $label = $el.find('label');
            let $input = $el.find('input');

            // remove disable ones
            if ($input.prop('disabled')) {
                return
            }

            // join
            data_input.push($label.text())
            data_input.push(
                $input.prop('type') === 'checkbox' ?
                    $input.prop('checked') ? 'Sim': 'Não'
                    : $input.val()
            )
        })

        $('.form-hcm-2000 .row, .form-hcm-7-edition .row').each(function (key, el) {
            // get the labels and inputs
            let $el = $(el);
            let $label = $el.find('label');
            let $input = $el.find('select option:selected');

            // join
            data_input.push($label.text())
            data_input.push($input.text())
        })

        // preparation to send the post outputs
        $([ 'label_fhv','fhv','fhv_2022',
            'label_vp','vp','vp_2022',
            'label_ffs','FFS_o','FFS_o_2022',
            'label_capacidade','c','c_2022',
            'label_velocidade_media','S','S_2022',
            'label_densidade','D','D_2022',
            'label_service_level','service_level','service_level_2022'
        ]).each(function (key, el) {
            let $element = $(`#${el}`);
            data_output.push($element.val() || $element.text())
        })

        $.ajax({
            url: $('#outputs').attr('action'),
            method: 'POST',
            data: { input: data_input, output : data_output },
            xhrFields: {
                responseType: 'blob'
            },
            success: function (data) {
                // Create a URL object from the binary data
                let url = URL.createObjectURL(data);

                // Create a temporary anchor element to trigger the download
                let a = document.createElement('a');
                a.href = url;
                a.download = 'AEexported_'+ moment().format('DD_MM_YYYY H:m')+'.xlsx';
                a.style.display = 'none';
                document.body.appendChild(a);
                a.click();

                // Clean up the URL object and the temporary anchor element
                URL.revokeObjectURL(url);
                document.body.removeChild(a);
            },
            error: function (xhr, status, error) {
                console.error('Error downloading the file:', error);
            }
        });
    })
</script>
<script defer>
    $('#Calcular').click(function(e) {
        console.log('entrei')
        e.preventDefault();
        // HCM2000
        let car_volume_d = parseInt($('#car_volume_d').val());
        let car_volume_o = parseInt($('#car_volume_o').val());
        let N_acessos = parseInt($('#N_acessos').val());
        let phf = parseFloat($('#phf').val());
        let PT = parseInt($('#pt').val());
        let PR = parseInt($('#pr').val());
        let berma = parseFloat($('#berma').val());
        let via = parseFloat($('#via').val())
        let length = parseFloat($('#length').val());
        let BFFS = parseFloat($('#BFFS').val());
        let fg_s_d = 0;
        let fg_ts_d = 0;
        let fg_s_o = 0;
        let fg_ts_o = 0;
        let ET_s_d = 0;
        let ER_s_d = 0;
        let ET_s_o = 0;
        let ER_s_o = 0;
        let ET_ts_d = 0;
        let ER_ts_d = 0;
        let ET_ts_o = 0;
        let ER_ts_o = 0;
        let vd_s = 0;
        let vo_s = 0;
        let vd_ts =0;
        let vo_ts=0;
        let SFM = 0;
        let fa=0;
        let fls=0;
        let FFS = 0;
        let FFS_2022 = 0;
        let ATS_d = 0;
        let fnp_s = 0;
        let BPTSF_d = 0;
        let a=0;
        let b=0;
        let PTSF_d = 0;
        let fnp_ts=0;
        let classe_estrada = 0;
        let LOS = "";
        let LOS_2022 = "";
        //hcm2022
        let fls_2022 =0;
        if ($('#car_volume_d').val() === '' || $('#phf').val() === '' || $('#pt').val() === ''|| $('#pr').val() === '' ||  $('input[name="FFS"]:checked').length === 0 || $('input[name="terreno"]:checked').length === 0) {
            alert("Preencha todos os campos necessários");
            return
        }else if ($('#FFS_m').is(":checked") && $('#FFS').val()===''){
            alert("Introduza o valor do FFS (km/h)");
            return;
        }else if ($('#FFS_c').is(":checked") && ($('#berma').val() === '' || $('#length').val() === '' || $('#N_acessos').val() === '' || $('#via').val() === '' || $('#BFFS').val() === '')) {
            alert("Preencha todos os campos necessários para calcular o FFS");
            return;
        }
        // Campos preenchidos, prosseguir com o cálculo
        if ($('#ondulado').is(":checked")) {
            if(car_volume_d =>0 && car_volume_d<=600){
                fg_s_d=0.71;
                fg_ts_d=0.77;
                ET_s_d=2.5;
                ER_s_d=1.1;
                ET_ts_d=1.8;
                ER_ts_d=1.0;

            }else if(car_volume_d=>600 && car_volume_d<=1200){
                fg_s_d=0.93;
                fg_ts_d=0.94;
                ET_s_d=1.9;
                ER_s_d=1.1;
                ET_ts_d=1.5;
                ER_ts_d=1.0;
            }else if(car_volume_d>1200){
                fg_s_d=0.99;
                fg_ts_d=1.00;
                ET_s_d=1.5;
                ER_s_d=1.1;
                ET_ts_d=1.0;
                ER_ts_d=1.0;
            }
        }else if ($('#plano').is(":checked")) {
            fg_s_d = 1.00;
            fg_ts_d = 1.00;
            if(car_volume_d=>0 && car_volume_d<=600){
                ET_s_d=1.7;
                ER_s_d=1.0;
                ET_ts_d=1.1;
                ER_ts_d=1.0;
            }else if(car_volume_d=>600 && car_volume_d<=1200){
                ET_s_d=1.2;
                ER_s_d=1.0;
                ET_ts_d=1.1;
                ER_ts_d=1.0;
            }else if(car_volume_d>1200){
                ET_s_d=1.1;
                ER_s_d=1.0;
                ET_ts_d=1.0;
                ER_ts_d=1.0;
            }
        }
        //sentido oposto
        //
        if ($('#ondulado').is(":checked")) {
            if(car_volume_o=>0 && car_volume_o<=600){
                fg_s_o=0.71;
                fg_ts_o=0.77;
                ET_s_o=2.5;
                ER_s_o=1.1;
                ET_ts_o=1.8;
                ER_ts_o=1.0;

            }else if(car_volume_o=>600 && car_volume_o<=1200){
                fg_s_o=0.93;
                fg_ts_o=0.94;
                ET_s_o=1.9;
                ER_s_o=1.1;
                ET_ts_o=1.5;
                ER_ts_o=1.0;
            }else if(car_volume_o>1200){
                fg_s_o=0.99;
                fg_ts_o=1.00;
                ET_s_o=1.5;
                ER_s_o=1.1;
                ET_ts_o=1.0;
                ER_ts_o=1.0;
            }
        }else if ($('#plano').is(":checked")) {
            fg_s_o = 1.00;
            fg_ts_o = 1.00;
            if(car_volume_o=>0 && car_volume_o<=600){
                ET_s_o=1.7;
                ER_s_o=1.0;
                ET_ts_o=1.1;
                ER_ts_o=1.0;
            }else if(car_volume_o=>600 && car_volume_o<=1200){
                ET_s_d=1.2;
                ER_s_d=1.0;
                ET_ts_d=1.1;
                ER_ts_d=1.0;
            }else if(car_volume_o>1200){
                ET_s_o=1.1;
                ER_s_o=1.0;
                ET_ts_o=1.0;
                ER_ts_o=1.0;
            }
        }

        //sentido oposto
        fhv_s_d = fhv_f(PT,ET_s_d,PR,ER_s_d); // Passo 2
        fhv_ts_d = fhv_f(PT,ET_ts_d,PR,ER_ts_d);
        fhv_s_o = fhv_f(PT,ET_s_o,PR,ER_s_o);
        fhv_ts_o = fhv_f(PT,ET_ts_o,PR,ER_ts_o);
        //passo3
        vd_s=vp_f(car_volume_d,phf,fg_s_d,fhv_s_d);
        $('#vd_s').val(vd_s.toFixed(0));
        vd_ts=vp_f(car_volume_d,phf,fg_ts_d,fhv_ts_d);
        $('#vd_ts').val(vd_ts.toFixed(0));
        vo_s=vp_f(car_volume_o,phf,fg_s_o,fhv_s_o);
        $('#vo_s').val(vo_s.toFixed(0));
        vo_ts=vp_f(car_volume_o,phf,fg_ts_o,fhv_ts_o);
        $('#vo_ts').val(vo_ts.toFixed(0));
        var fhvmax=[fhv_s_d,fhv_ts_d];
        var max = Math.max(...fhvmax);
        //débito
        let vd_2022 = 0;
        vd_2022 = v_f(car_volume_d,phf)
        $('#vd_2022').val(vd_2022);
        //classe vertical (i,L)
        let classe = 1;
        //BFFS
        let spl = parseFloat($('#SPL').val());
        let BFFS_2022 = 0;
        BFFS_2022 = BFFS_f(spl/1.61)
        $('#BFFS_2022').val(BFFS_2022*1.61);
        let vo_2022 = 0;
        //passo 4
        if(vd_s>1700 || vo_s>1700 || vd_ts>1700 || vo_ts>1700){
            $('#service_level').val("F");
        }else{
            if($('#FFS_m').is(":checked")){
                let SFM = parseFloat($('#SFM').val());
                FFS=SFM+0.0125*(car_volume_d/fhv_s_d);
                FFS_2022=FFS
                $('#FFS_o').val(FFS.toFixed(2));
                $('#FFS_o_2022').val(FFS_2022*1.61.toFixed(0));

            }else{
                fls=f_ls(berma,via);
                fls_2022=fLS_f_2022(via/0.305,berma/0.305);
                fa=fa_f(N_acessos);
                fa_2022 = fA_f_2022(N_acessos);
                a_2022 = a_f(classe,vo_2022,length/1.61,BFFS_2022)
                FFS_2022 = FFS_f_2022(BFFS_2022,a,PT,fls_2022,fa_2022)
                FFS=FFS_f(BFFS,fls,fa)
                $('#FFS_o').val(FFS.toFixed(0));
                $('#FFS_o_2022').val(FFS_2022*1.61.toFixed(0));
                //if ($('#classe_estrada').val()==="I"){
            }
            //escrever aqui o restante código
            fnp_s = 3;//falta meter a funcionar
            ATS_d=Ats_f(FFS,vd_s,vo_s,fnp_s)
            $('#ATS_d').val(ATS_d.toFixed(2))
            a=1;//falta meter a funcionar
            b=2;//falta meter a funcionar
            BPTSF_d=BPTSF_f(vd_ts,a,b)
            $('#BPTSF_d').val((BPTSF_d).toFixed(2))
            fnp_ts=3;//falta meter a funcionar
            PTSF_d=PTSF_f(BPTSF_d,fnp_ts)
            $('#PTSF_d').val(((PTSF_d)).toFixed(2))
            if ($('#classe_estrada').val()==="1"){
                clase_estrada=1;
            }else{
                classe_estrada=2;
            }
            LOS=LOS_f(classe_estrada,ATS_d,PTSF_d)
            $('#service_level').val(LOS);

            let m1_2022 = 0;
            let p1_2022 = 0;
            let S_2022 = 0;
            let PF25cap_2022 = 0;
            let PFcap_2022 = 0;
            let m2_2022 = 0;
            let p2_2022 = 0;
            let cap = 1700;
            let PF_2022 = 0;
            let FD_2022 = 0;
            m1_2022=m1_f_2022(classe,vo_2022,length/1.61,PT,FFS_2022);
            p1_2022=p1_f_2022(classe,FFS_2022,PT,length/1.61,vo_2022);
            S_2022 = S_f_2022(vd_2022,m1_2022,p1_2022);
            $('#S_2022').val(S_2022/1.61.toFixed(2));
            PF25cap_2022=PF25cap_f(classe,length/1.61,FFS,PT,vo_2022);
            $('#PF25cap_2022').val((PF25cap_2022.toFixed(2)));
            PFcap_2022=PFcap_f(classe,length/1.61,FFS,PT,vo_2022);
            $('#PFcap_2022').val((PFcap_2022.toFixed(2)));
            m2_2022=m2_f_2022(PFcap_2022,PF25cap_2022,cap);
            p2_2022=p2_f_2022(PFcap_2022,PF25cap_2022,cap);
            PF_2022=PF_f(m2_2022,p2_2022,vd_2022);
            $("#PF_2022").val(PF_2022.toFixed(2));
            FD_2022=PF_f(m2_2022,p2_2022,vd_2022);
            $("#FD_2022").val(FD_2022/1.61.toFixed(2));
            LOS_2022=NS2022_f(spl/1.61,FD_2022,vd_2022,vo_2022)
            $('#service_level_2022').val(LOS_2022);
        }

        $('#Exportar').attr('disabled', false)
    })
    $('#Limpar').click(function(e) {
        e.preventDefault();
        ///inputs
        $('input[name="terreno"]').prop('checked', false);
        $('input[name="FFS"]').prop('checked', false);
        $('#car_volume').val('');
        $('#N_acessos').val('');
        $('#phf').val('');
        $('#pt').val('');
        $('#pr').val('');
        $('#berma').val('');
        $('#FFS').val('');
        $('#via').val('')
        $('#length').val('');
        $('#N_vias').val('');
        $('#BFFS').val('');
        $('#tipos_de_condutores').val("")
        $('#cond_atmos').val("")
        ///outputs
        $('#fhv').val('');
        $('#fhv_2022').val('');
        $('#vp').val('');
        $('#vp_2022').val('');
        $('#FFS_o').val('');
        $('#FFS_o_2022').val('');
        $('#S').val('');
        $('#S_2022').val('');
        $('#c').val('');
        $('#c_2022').val('');
        $('#D').val('');
        $('#service_level').val("");
        $('#D_2022').val('');
        $('#service_level_2022').val("");
    })
</script>
</html>
